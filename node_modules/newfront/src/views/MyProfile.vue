<template>
  <!-- âœ… UserInfo ì•„ëž˜ì— UserSummary í¬í•¨ -->
  <div class="container">
    <div class="user-info-block">
      <UserInfo :user="user" @logout="logout" @deleteAccount="deleteAccount" />
      <UserSummary :photos="photos" />
    </div>

    <!-- 2. ì¤‘ì•™ -->
    <MainPhotos
      :mainPhoto="mainPhoto"
      :cameraActive="cameraActive"
      @startCamera="startCamera"
      @handlePhotoUploaded="handlePhotoUploaded"
    />

    <!-- 3. ì˜¤ë¥¸ìª½ -->
    <div class="photo-list-section">
      <PhotoList
        :filteredPhotos="filteredPhotos"
        :mainPhotoId="mainPhoto?.id"
        :selectedPhoto="selectedPhoto"
        v-model:selectedDate="selectedDate"  
        :formatTime="formatTime"
        @showPhoto="showPhoto"
        @deletePhoto="deletePhoto"
      />
    </div>

    <!-- 4. í•˜ë‹¨ ì „ì²´ ë„ˆë¹„ -->
    <div class="full-width">
      <SummaryStats :photos="photos" />
    </div>
  </div>
</template>

<script>
import axios from "axios";
import { ref, onMounted, watch, computed } from "vue";
import { useRouter } from "vue-router";
import UserInfo from '../components/UserInfo.vue';
import PhotoList from '../components/PhotoList.vue';
import MainPhotos from '../components/Mainphotos.vue';
import SummaryStats from '../components/SummaryStats.vue';
import UserSummary from '../components/UserSummary.vue';

export default {
  components: {
    UserInfo,
    PhotoList,
    MainPhotos,
    SummaryStats,
    UserSummary
  },
  setup() {
    const router = useRouter();
    const user = ref({});
    const photos = ref([]);
    const mainPhoto = ref(null);
    const selectedPhoto = ref(null);
    const cameraActive = ref(false);
    const selectedDate = ref("");

    const filteredPhotos = computed(() => {
      if (!selectedDate.value) return photos.value;
      return photos.value.filter(photo => {
        const dateOnly = new Date(photo.uploaded_at).toISOString().split("T")[0];
        return dateOnly === selectedDate.value;
      });
    });

    const formatTime = (datetime) => {
      const date = new Date(datetime);
      const month = (date.getMonth() + 1).toString().padStart(2, '0');
      const day = date.getDate().toString().padStart(2, '0');
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `${month}ì›” ${day}ì¼ ${hours}:${minutes}`;
    };

    watch(photos, (newVal) => {
      console.log("ðŸ“¸ ì‚¬ì§„ ëª©ë¡ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤:", newVal);
    });

    const fetchUser = async () => {
      try {
        const token = localStorage.getItem("token");
        if (!token) return console.error("âŒ ì•¡ì„¸ìŠ¤ í† í° ì—†ìŒ");

        const decodedToken = JSON.parse(atob(token.split(".")[1]));
        const email = decodedToken.email;

        const res = await axios.get(`http://210.101.236.158:5000/api/user/me?email=${email}`, {
          headers: { Authorization: `Bearer ${token}` },
        });

        if (res.data.success) {
          user.value = res.data.user;
          await fetchPhotos();
        } else {
          console.error("âŒ ì‚¬ìš©ìž ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", res.data.message);
        }
      } catch (err) {
        console.error("âŒ ì‚¬ìš©ìž ì •ë³´ë¥¼ ë³´ë‚´ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜:", err);
      }
    };

    const fetchPhotos = async () => {
      if (!user.value.id) return console.error("âŒ user_idê°€ ì—†ìŒ");
      try {
        const res = await axios.get(`http://210.101.236.158:5000/api/photos?user_id=${user.value.id}`);
        photos.value = res.data;
        mainPhoto.value = photos.value.length > 0 ? photos.value[0] : null;
      } catch (err) {
        console.error("ðŸš¨ ì‚¬ì§„ ëª©ë¡ì„ ë³´ë‚´ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜:", err);
      }
    };

    const handlePhotoUploaded = async () => {
      if (!user.value.id) return;
      setTimeout(async () => {
        try {
          const res = await axios.get(`http://210.101.236.158:5000/api/photos?user_id=${user.value.id}`);
          photos.value = res.data;
          mainPhoto.value = photos.value.length > 0 ? photos.value[0] : null;
        } catch (err) {
          console.error("ðŸš¨ ì‚¬ì§„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:", err);
        }
      }, 1000);
    };

    const deletePhoto = async (id) => {
      if (id === mainPhoto.value.id) return alert("ëŒ€í‘œ ì‚¬ì§„ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      try {
        const res = await axios.delete(`http://210.101.236.158:5000/api/photos/${id}`);
        if (res.data.success) {
          alert("ì‚¬ì§„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          fetchPhotos();
        } else {
          console.error("ðŸš¨ ì‚¬ì§„ ì‚­ì œ ì‹¤íŒ¨:", res.data.message);
        }
      } catch (err) {
        console.error("ðŸš¨ ì‚¬ì§„ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:", err);
      }
    };

    const showPhoto = (photo) => {
      selectedPhoto.value = photo;
    };

    const deleteAccount = async () => {
      if (confirm("ì •ë§ íšŒì› íƒˆí‡´ë¥¼ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê½ƒ")) {
        try {
          const res = await axios.delete(`http://210.101.236.158:5000/api/user/delete/${user.value.id}`);
          if (res.data.success) {
            localStorage.removeItem("token");
            alert("íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            router.push("/login");
          } else {
            alert("íšŒì› íƒˆí‡´ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        } catch (err) {
          alert("íšŒì› íƒˆí‡´ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
      }
    };

    const logout = () => {
      localStorage.removeItem("token");
      router.push("/login");
    };

    const startCamera = () => {
      cameraActive.value = true;
    };

    onMounted(fetchUser);

    return {
      user,
      photos,
      mainPhoto,
      selectedPhoto,
      uploadPhoto: () => {},
      deletePhoto,
      showPhoto,
      deleteAccount,
      logout,
      startCamera,
      cameraActive,
      handlePhotoUploaded,
      formatTime,
      selectedDate,
      filteredPhotos
    };
  }
};
</script>

<style scoped>
.container {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 30px;
  padding: 30px;
  max-width: 1800px;
  margin: 0 auto;
  background-color: #f9f9f9;
  font-family: 'Segoe UI', sans-serif;
}

.container > * {
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
}

.user-info-block {
  max-width: 280px;
  flex: none;
  background-color: #e6f2ff;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.container > :nth-child(2) {
  flex: 2;
  background-color: #fffbea;
}

.container > :nth-child(3) {
  flex: 2;
  background-color: #ffffff;
}

.container > .full-width {
  flex-basis: 100%;
  width: 100%;
  background-color: #f4fff4;
  border: 1px solid #bde5bd;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  text-align: center;
}

.container h2, .container h3 {
  color: #2c3e50;
  border-bottom: 2px solid #eee;
  padding-bottom: 6px;
  margin-bottom: 12px;
  font-weight: 600;
}

@media (max-width: 1000px) {
  .container {
    flex-direction: column;
  }

  .container > * {
    max-width: 100%;
  }
}

.full-width {
  flex-basis: 100%;
  width: 100%;
  margin-top: 20px;
  background-color: #f4fff4;
  border: 1px solid #bde5bd;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.photo-list-section {
  flex: 2;
  min-width: 380px;
}

.user-stats {
  margin-top: 20px;
  font-size: 14px;
  color: #333;
  line-height: 1.6;
  background-color: #f8fbff;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #ddeeff;
}
.user-stats hr {
  margin-bottom: 12px;
  border: none;
  border-top: 1px solid #ccc;
}
</style>
